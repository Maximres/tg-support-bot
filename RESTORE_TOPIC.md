# Восстановление удаленного топика

## Проблема

Если топик был случайно удален в Telegram, сообщения начинают отправляться в General чат вместо топика.

## Автоматическое восстановление

Бот автоматически обнаруживает удаленные топики и пересоздает их в следующих случаях:

1. **При ошибке TOPIC_NOT_FOUND или TOPIC_DELETED** - бот автоматически очищает старый `topic_id` и создает новый топик
2. **При отправке сообщения** - если сообщение отправлено с `topic_id`, но в ответе Telegram API нет `message_thread_id`, бот пересоздает топик

## Ручное восстановление

### Вариант 1: Восстановить топик для конкретного пользователя

По Chat ID пользователя:
```bash
docker-compose exec app php artisan topic:restore --chat-id=123456789
```

По ID пользователя в БД:
```bash
docker-compose exec app php artisan topic:restore --user-id=42
```

### Вариант 2: Восстановить все топики без topic_id

```bash
docker-compose exec app php artisan topic:restore --all
```

Эта команда найдет всех пользователей без `topic_id` и создаст для них новые топики.

## Как это работает

1. Команда очищает старый `topic_id` (если он есть)
2. Ставит задачу `TopicCreateJob` в очередь
3. Задача создает новый топик с правильным названием (включая имя и номер телефона, если доступны)
4. Сохраняет новый `topic_id` в БД
5. Отправляет контактное сообщение в новый топик

## Проверка после восстановления

1. Отправьте сообщение пользователю
2. Проверьте, что сообщение появилось в новом топике (не в General)
3. Проверьте название топика - должно быть в формате `#ID Имя Фамилия +номер`

## Логи

Проверьте логи для диагностики:
```bash
docker-compose logs -f app | grep -i "topic"
docker-compose logs -f queue | grep -i "topic"
```

## Примечания

- При восстановлении топика сохраняется кастомное название (если оно было установлено)
- Номер телефона будет добавлен в название, если он был сохранен ранее
- Старые сообщения останутся в General чате - их нужно будет переместить вручную (если нужно)

