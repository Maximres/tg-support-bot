# Инструкция по безопасному обновлению сервера

## Обзор

Скрипт `update-server.sh` предназначен для безопасного обновления запущенного сервера с ботом через Docker без простоя. Скрипт автоматически:

1. Создает резервную копию базы данных
2. Получает последние изменения из Git
3. Пересобирает только измененные Docker контейнеры
4. Плавно перезапускает сервисы с проверкой health checks
5. Применяет миграции базы данных
6. Очищает и пересоздает кеш Laravel
7. Проверяет работоспособность после обновления
8. Выполняет откат при ошибках

## Требования

- Docker и Docker Compose установлены
- Git установлен
- Доступ к серверу по SSH
- Права на выполнение скрипта

## Использование

### Базовое использование

Обновление текущей ветки:

```bash
./update-server.sh
```

### Обновление конкретной ветки

```bash
./update-server.sh main
./update-server.sh develop
```

### Предоставление прав на выполнение

Если скрипт не выполняется, предоставьте права:

```bash
chmod +x update-server.sh
```

## Процесс обновления

### Шаг 1: Резервное копирование

Скрипт автоматически создает резервную копию базы данных перед обновлением:

```
backups/pre-update-backup-YYYYMMDD_HHMMSS.sql
```

### Шаг 2: Получение изменений

Скрипт:
- Сохраняет текущее состояние Git
- Получает последние изменения из удаленного репозитория
- Переключается на указанную ветку
- Обновляет код

**Важно:** Если есть незакоммиченные изменения, они будут автоматически сохранены в stash.

### Шаг 3: Пересборка контейнеров

Скрипт определяет, какие файлы изменились:
- Если изменились `Dockerfile` или `docker-compose.yml`, выполняется полная пересборка
- Если изменился только код приложения, пересобираются только измененные слои

### Шаг 4: Применение миграций

Автоматически применяются все новые миграции базы данных:

```bash
php artisan migrate --force
```

### Шаг 5: Плавный перезапуск

Контейнеры перезапускаются по одному с проверкой health checks:
1. `app` - основное приложение
2. `queue` - обработчик очереди
3. `nginx` - веб-сервер

Каждый контейнер проверяется на готовность перед запуском следующего.

### Шаг 6: Очистка и кеширование

Выполняется полная очистка и пересоздание кеша Laravel:
- Конфигурация
- Маршруты
- Представления
- Общий кеш приложения

### Шаг 7: Проверка работоспособности

Скрипт проверяет:
- Статус всех контейнеров
- Доступность приложения через HTTP
- Подключение к базе данных

## Откат при ошибках

Если на любом этапе возникает ошибка, скрипт автоматически выполняет откат:

1. Восстанавливает предыдущее состояние Git
2. Перезапускает контейнеры
3. Выводит сообщение об ошибке

**Важно:** Резервная копия БД сохраняется даже при откате.

## Ручной откат

Если нужно выполнить откат вручную:

### Откат кода

```bash
git reset --hard HEAD@{1}
# или
git reset --hard <commit-hash>
```

### Восстановление базы данных

```bash
docker-compose exec -T pgdb psql -U postgres tg_support_bot < backups/pre-update-backup-YYYYMMDD_HHMMSS.sql
```

### Перезапуск контейнеров

```bash
docker-compose restart
```

## Health Checks

Все сервисы имеют настроенные health checks:

- **app**: Проверка доступности PHP-FPM (порт 9000)
- **pgdb**: Проверка готовности PostgreSQL через `pg_isready`
- **redis**: Проверка работы Redis через `redis-cli ping`
- **queue**: Базовая проверка PHP
- **nginx**: Проверка доступности HTTP endpoint

Health checks помогают определить, когда контейнеры готовы к работе.

## Оптимизация Dockerfile

Dockerfile оптимизирован для быстрых обновлений:

1. **Кеширование зависимостей**: `composer.json` и `package.json` копируются отдельно
2. **Многослойная сборка**: Зависимости устанавливаются до копирования всего кода
3. **Оптимизация автозагрузчика**: Используется `composer dump-autoload --optimize`

При изменении только кода приложения (без изменения зависимостей) пересборка происходит быстрее.

## Мониторинг после обновления

После успешного обновления рекомендуется проверить:

### Логи приложения

```bash
docker-compose logs -f app
```

### Логи очереди

```bash
docker-compose logs -f queue
```

### Статус контейнеров

```bash
docker-compose ps
```

### Проверка бота

```bash
./check-bot.sh
```

## Часто задаваемые вопросы

### Что делать, если обновление прервалось?

Скрипт автоматически выполнит откат. Проверьте логи и исправьте ошибки перед повторным запуском.

### Можно ли обновить только код без пересборки контейнеров?

Нет, для применения изменений кода требуется пересборка контейнеров. Однако Docker использует кеш слоев, поэтому пересборка будет быстрой.

### Что происходит с незакоммиченными изменениями?

Незакоммиченные изменения автоматически сохраняются в Git stash перед обновлением. После обновления их можно восстановить:

```bash
git stash list
git stash pop
```

### Как часто нужно обновлять сервер?

Рекомендуется обновлять сервер регулярно:
- После каждого важного коммита в production ветку
- Перед применением критических исправлений безопасности
- По расписанию (например, раз в неделю)

### Можно ли обновить сервер во время активной работы бота?

Да, скрипт разработан для обновления без простоя. Однако рекомендуется обновлять в периоды низкой нагрузки.

## Безопасность

- Всегда создается резервная копия БД перед обновлением
- Изменения применяются атомарно
- Автоматический откат при ошибках
- Проверка работоспособности после обновления

## Поддержка

При возникновении проблем:

1. Проверьте логи: `docker-compose logs`
2. Проверьте статус контейнеров: `docker-compose ps`
3. Выполните откат при необходимости
4. Обратитесь к документации проекта

